#!/usr/bin/python
#coding:utf-8
#Author:Jean

from lib.GetAssetInfo import *
from lib.GetSubDomain import *

def GetOptions():
	optParser = OptionParser()
	optParser.add_option('-d','--domain',action = 'store',type = "string" ,dest = 'domain',help='Domain')
	optParser.add_option('-p','--port',action = 'store',type = "string" ,dest = 'port',help='port')
	optParser.add_option('-P','--page',action = 'store',type = "string" ,dest = 'page',help='page')
	optParser.add_option('-f','--filename',action = 'store',type = "string" ,dest = 'filename',help='filename')
	(options, args) = optParser.parse_args() 
	return (options,args)

	
def main():
	(options,args)=GetOptions()
	file=open(str(options.filename),"w+")
	classdomain=Domain(str(options.domain),str(options.port),str(options.page),str(options.filename))
	html=HtmlReport()
	GetAssetResult=GetAsset(str(options.domain),str(options.port),str(options.page),str(options.filename))

	tabletd=''
	tabletd1=html.TableMain % dict(Type="操作系统类型(Ping)",result = '%s'%GetAssetResult.GetOsType(),)
	tabletd2=html.TableMain % dict(Type="地理位置",result = '%s'%GetAssetResult.GetIpAddress(),)
	tabletd3=html.TableMain % dict(Type="Nmap扫描",result = '%s'%GetAssetResult.GetPort(),)
	tabletd4=html.TableMain % dict(Type="域名备案信息",result = '%s'%GetAssetResult.GetBeiAn(),)
	tabletd5=html.TableMain % dict(Type="子域名(百度/Bing/360/Sogou)",result = '%s'%classdomain.GetDomainFinal(),)
	tabletd6=html.TableMain % dict(Type="子域名对应的IP清单",result = '%s'%classdomain.GetSubDomainInfo(),)
	tabletd7=html.TableMain % dict(Type="历史解析(域名)/绑定过的历史域名(IP)",result = '%s'%GetAssetResult.GetIPinfo(),)
	tabletd8=html.TableMain % dict(Type="子域名的历史ip解析记录/子域名当前IP绑定过的历史域名",result = '%s'%classdomain.GetDomainHistoryIP(),)
	tabletd9=html.TableMain % dict(Type="Whois信息(python-whois)",result = '%s'%GetAssetResult.GetWhois1(),)
	tabletd10=html.TableMain % dict(Type="Whois信息(whois.4.cn)",result = '%s'%GetAssetResult.GetWhois2(),)
	tabletd11=html.TableMain % dict(Type="Whois历史信息(whois.4.cn)",result = '%s'%GetAssetResult.GetWhois3(),)

	tabletd+=tabletd1
	tabletd+=tabletd2
	tabletd+=tabletd3
	tabletd+=tabletd4
	tabletd+=tabletd5
	tabletd+=tabletd6
	tabletd+=tabletd7
	tabletd+=tabletd8
	tabletd+=tabletd9
	tabletd+=tabletd10
	tabletd+=tabletd11

	output=html.HtmlMain % dict(value="%s"%options.domain,table_tr=tabletd,)
	filename='AssetInfoCollReport_{target}_{date}.html'.format(target=options.domain,date=time.strftime('%Y%m%d%H%M%S'))
	print(filename)
	with open(filename, 'wb') as f:
		f.write(output.encode('utf8'))
if __name__=="__main__":
	try:
		main()
	except Exception as e:
		print(e)